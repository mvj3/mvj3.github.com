---
layout: post
title: '最近访客实现'
published: true
comments: true
date: 2013-01-30 18:19:00 +08:00
categories: [API, Algorithm]
---


问题分两个，一个是后端，一个是前端。
-----------------------------------------
对后端来说，用户每次blog/index|show访问都生成访问记录，后端需要进行排重和去掉未登陆用户。如果在该次访问里进行，特别是某个博客突然火了，必然每次访问都产生IO(磁盘或网络，因为多进程要共享信息），所以必定是异步的。

前端展示考虑到缓存，一般是页面片段缓存，或者ajax载入。

后端异步如何计算每个blog的最近访客，log.js记录了最近访问，一个后台常驻进程循环对日志表按时间记录来读取blog访问信息，把最近访客信息刷新。相对单次请求全部处理，这里处理次数更少，资源更节约，当然瓶颈也在日志表的索引更新和读取。
 
把当前自己的访问也添加上
-----------------------------------------
上面唯一的缺陷是不能马上在当次访问里加上当前自己的访客信息，这个其实可以通过一个技巧来解决，那就是在浏览器里去把ajax获取来的访客列表加上自己的访客信息就OK了。两个注意点是排重和排除访问自己的页面。
